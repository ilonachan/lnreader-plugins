var t=this&&this.__awaiter||function(t,e,n,a){return new(n||(n=Promise))((function(r,o){function i(t){try{l(a.next(t))}catch(t){o(t)}}function s(t){try{l(a.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,s)}l((a=a.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var n,a,r,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=s(0),i.throw=s(1),i.return=s(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(l){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(o=0)),o;)try{if(n=1,a&&(r=2&s[0]?a.return:s[0]?a.throw||((r=a.return)&&r.call(a),0):a.next)&&!(r=r.call(a,s[1])).done)return r;switch(a=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,a=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(r=o.trys,(r=r.length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){o.label=s[1];break}if(6===s[0]&&o.label<r[1]){o.label=r[1],r=s;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(s);break}r[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],a=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}};Object.defineProperty(exports,"__esModule",{value:!0});var n=require("@libs/fetch"),a=require("@libs/filterInputs"),r=require("cheerio"),o=require("@libs/defaultCover"),i=require("@libs/novelStatus"),s=require("@libs/storage"),l=function(){function l(){var t=this;this.id="mznovels",this.name="MZ Novels",this.icon="src/en/mznovels/icon.png",this.customCSS="src/en/mznovels/customCss.css",this.customJS="src/en/mznovels/customJs.js",this.site="https://mznovels.com",this.version="1.0.1",this.filters={rank_type:{label:"Ranking Type",options:[{label:"Original",value:"original"},{label:"Translated",value:"translated"},{label:"Fanfiction",value:"fanfiction"}],type:a.FilterTypes.Picker,value:"original"},rank_period:{label:"Ranking Period",options:[{label:"Daily",value:"daily"},{label:"Weekly",value:"weekly"},{label:"Monthly",value:"monthly"}],type:a.FilterTypes.Picker,value:"daily"}},this.imageRequestInit=void 0,this.pluginSettings={authorNotes:{label:"Author Notes",type:a.FilterTypes.Picker,value:"footnotes",options:[{label:"Inline",value:"inline"},{label:"Footnotes",value:"footnotes"},{label:"None",value:"none"}]}},this.webStorageUtilized=!1,this.resolveUrl=function(e,n){return t.normalizePath(e)}}return l.prototype.normalizePath=function(t,e){return void 0===e&&(e=!0),t?t.startsWith("/")?e?this.site+t:t:(t.startsWith(this.site)||console.warn("path doesn't seem to belong to this site"),e?t:t.slice(this.site.length)):t},l.prototype.normalizeAvatar=function(t){return"https://mznovels.com/media/avatars/default.png"===(t=this.normalizePath(t,!0))?o.defaultCover:t},l.prototype.parseSearchResults=function(t,e){var n=this;if(t("div.pagination > span.active").text()!==e.toString())return[];var a=[];return t("ul.search-results-list > li.search-result-item:not(.ad-result-item)").each((function(e,r){var i,s=t(r),l=s.find("h2.search-result-title").first().text(),c=n.normalizePath(s.find("a.search-result-title-link").first().attr("href")),u=null!==(i=n.normalizePath(s.find("img.search-result-image").attr("src")))&&void 0!==i?i:o.defaultCover;c&&a.push({name:l,path:c,cover:u})})),a},l.prototype.applyLocalFilters=function(t,e){return t},l.prototype.popularNovels=function(a,o){return t(this,arguments,void 0,(function(t,a){var o,i,s,l,c,u,p,h,f=a.showLatestNovels,v=a.filters;return e(this,(function(e){switch(e.label){case 0:return o=f?this.normalizePath("/latest-updates/?page=".concat(t)):this.normalizePath("/rankings/".concat(null!==(u=null===(c=null==v?void 0:v.rank_type)||void 0===c?void 0:c.value)&&void 0!==u?u:"original","?period=").concat(null!==(h=null===(p=null==v?void 0:v.rank_period)||void 0===p?void 0:p.value)&&void 0!==h?h:"daily","&page=").concat(t)),[4,(0,n.fetchApi)(o)];case 1:if(!(i=e.sent()).ok)throw new Error("Captcha error, please open in webview");return[4,i.text()];case 2:return s=e.sent(),l=(0,r.load)(s),[2,this.parseSearchResults(l,t)]}}))}))},l.prototype.parseNovel=function(a){return t(this,void 0,void 0,(function(){var t,s,l,c,u,p,h,f,v,d,m,b,g,y,w,k,x,z,P,C,N,S,_,q,A,F=this;return e(this,(function(e){switch(e.label){case 0:return t={path:a,name:"Untitled"},s=this.normalizePath(a),[4,(0,n.fetchApi)(s)];case 1:if(!(l=e.sent()).ok)throw new Error("Captcha error, please open in webview");return[4,l.text()];case 2:switch(c=e.sent(),u=(0,r.load)(c),t.name=u("h1.novel-title").first().text(),t.cover=null!==(S=this.normalizePath(u("img#novel-cover-image").attr("src")))&&void 0!==S?S:o.defaultCover,u("span.category-value").text()){case"Original":p="original";break;case"Translated":p="translated";break;case"Fanfiction":p="fanfiction";break;default:p=null}h=u("p.novel-author > a").text(),"translated"===p&&(f="Unknown",u("div.translation-info-item").each((function(t,e){var n=u(e);"Original Author:"!==n.find("span.translation-label").text()||n.find("span.translation-value").hasClass("not-provided")||(f=n.find("span.translation-value").text())})),h="".concat(f," (translated by: ").concat(h,")")),t.author=h,v=[],p&&v.push("Category: ".concat(p)),u("div.genres-container > a.genre").each((function(t,e){v.push(u(e).text().replace(",","_"))})),u("div.tags-container > a.tag").each((function(t,e){v.push(u(e).text().replace(",","_"))})),t.genres=v.join(", "),d=u("span.status-indicator"),t.status=d.hasClass("completed")?i.NovelStatus.Completed:i.NovelStatus.Ongoing,t.summary=(null!==(_=u("p.summary-text").prop("innerHTML"))&&void 0!==_?_:"<no description>").trim(),(m=u("span.rating-score").text())&&(b=null===(A=null===(q=m.match(/^\((\d+\.\d+)\)$/))||void 0===q?void 0:q.groups)||void 0===A?void 0:A[1])&&(t.rating=parseFloat(b)),g=1,y=u,w=u("div#chapters .pagination").children().last().filter((function(t,e){return"a"===e.tagName})).attr("href"),k=w?parseInt(w.split("=")[1]):1,x=[],e.label=3;case 3:return g<=k?g>1?(z=s+"?page=".concat(g),[4,(0,n.fetchApi)(z)]):[3,6]:[3,7];case 4:if(!(P=e.sent()).ok)throw new Error("Captcha error, please open in webview");return C=r.load,[4,P.text()];case 5:y=C.apply(void 0,[e.sent()]),e.label=6;case 6:return y("ul.chapter-list > li.chapter-item").each((function(t,e){var n=y(e);x.push({name:n.find("span.chapter-title-text").text(),path:F.normalizePath(n.find("a.chapter-link").attr("href"))})})),g++,[3,3];case 7:return N=x.reverse().map((function(t,e){return t.chapterNumber=e+1,t})),t.chapters=N,[2,t]}}))}))},l.prototype.parseChapter=function(a){return t(this,void 0,void 0,(function(){var t,o,i,l,c,u,p,h,f;return e(this,(function(e){switch(e.label){case 0:return t=this.normalizePath(a),[4,(0,n.fetchApi)(t)];case 1:if(!(o=e.sent()).ok)throw new Error("Captcha error, please open in webview");return[4,o.text()];case 2:return i=e.sent(),l=(0,r.load)(i),(c=l("div.formatted-content")).remove("div.chapter-ad-banner"),u=l(".author-feedback"),p=null!==(f=s.storage.get("authorNotes"))&&void 0!==f?f:this.pluginSettings.authorNotes.value,console.log(s.storage.getAllKeys().map((function(t){return[t,s.storage.get(t)]}))),"inline"!==p&&(console.log(u),"footnotes"===p&&(h=[],u.each((function(t,e){var n=l(e),a=n.attr("data-note");a&&(h.push(a),n.append('<a class="footnote-ref" href="#footnote-'.concat(t+1,'"><sup>').concat(t+1,'</sup><span class="anchor"><span id="ref-').concat(t+1,'"></span></span></a>')))})),console.log(h),c.append('\n          <div class="footnotes">\n            '.concat(h.map((function(t,e){return'\n                <a class="footnote-num" href="#ref-'.concat(e+1,'"><span class="anchor"><span id="footnote-').concat(e+1,'"></span></span><sup>').concat(e+1,'</sup></a>\n                <span class="footnote-content">').concat(t,"</span>\n            ")})).join(""),"\n          </div>\n        "))),u.children().unwrap()),l(".author_note > .note_content").each((function(t,e){c.append('\n        <blockquote class="author_note">\n          <h3>Author\'s Note</h3>\n          <p>'.concat(l(e).text(),"</p>\n        </blockquote>\n        "))})),[2,c.html()]}}))}))},l.prototype.searchNovels=function(a,o){return t(this,void 0,void 0,(function(){var t,i,s,l;return e(this,(function(e){switch(e.label){case 0:return t=this.normalizePath("/search/?q=".concat(a)),[4,(0,n.fetchApi)(t)];case 1:if(!(i=e.sent()).ok)throw new Error("Captcha error, please open in webview");return[4,i.text()];case 2:return s=e.sent(),l=(0,r.load)(s),[2,this.parseSearchResults(l,o)]}}))}))},l}();exports.default=new l;