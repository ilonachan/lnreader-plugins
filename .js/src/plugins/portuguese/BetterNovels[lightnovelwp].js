var e=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))((function(i,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function n(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,n)}c((r=r.apply(e,t||[])).next())}))},t=this&&this.__generator||function(e,t){var s,r,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=n(0),o.throw=n(1),o.return=n(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function n(n){return function(c){return function(n){if(s)throw new TypeError("Generator is already executing.");for(;o&&(o=0,n[0]&&(a=0)),a;)try{if(s=1,r&&(i=2&n[0]?r.return:n[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,n[1])).done)return i;switch(r=0,i&&(n=[2&n[0],i.value]),n[0]){case 0:case 1:i=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==n[0]&&2!==n[0])){a=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){a.label=n[1];break}if(6===n[0]&&a.label<i[1]){a.label=i[1],i=n;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(n);break}i[2]&&a.ops.pop(),a.trys.pop();continue}n=t.call(e,a)}catch(e){n=[6,e],r=0}finally{s=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,c])}}};Object.defineProperty(exports,"__esModule",{value:!0});var s=require("cheerio"),r=require("htmlparser2"),i=require("@libs/fetch"),a=require("@libs/novelStatus"),o=require("@libs/defaultCover"),n=require("@libs/storage");function c(e,t){var s=e.match(/(\d+)$/);s&&s[0]&&(t.chapterNumber=parseInt(s[0]))}var l=new(function(){function l(e){var t,s,r;this.hideLocked=n.storage.get("hideLocked"),this.id=e.id,this.name=e.sourceName,this.icon="multisrc/lightnovelwp/".concat(e.id.toLowerCase(),"/icon.png"),this.site=e.sourceSite;var i=(null===(t=e.options)||void 0===t?void 0:t.versionIncrements)||0;this.version="1.1.".concat(10+i),this.options=null!==(s=e.options)&&void 0!==s?s:{},this.filters=e.filters,this.customJS=this.options.customRuntimeJs,this.customCSS=this.options.customCss,(null===(r=this.options)||void 0===r?void 0:r.hasLocked)&&(this.pluginSettings={hideLocked:{value:"",label:"Hide locked chapters",type:"Switch"}})}return l.prototype.getHostname=function(e){var t=(e=e.split("/")[2]).split(".");return t.pop(),t.join(".")},l.prototype.safeFetch=function(s,r){return e(this,void 0,void 0,(function(){var e,a,o,n,c,l,u,h;return t(this,(function(t){switch(t.label){case 0:return e=s.split("://"),a=e.shift(),o=e[0].replace(/\/\//g,"/"),[4,(0,i.fetchApi)(a+"://"+o)];case 1:if(!(n=t.sent()).ok&&1!=r)throw new Error("Could not reach site ("+n.status+") try to open in webview.");return[4,n.text()];case 2:if(c=t.sent(),l=null===(h=null===(u=c.match(/<title>(.*?)<\/title>/))||void 0===u?void 0:u[1])||void 0===h?void 0:h.trim(),this.getHostname(s)!=this.getHostname(n.url)||l&&("Bot Verification"==l||"You are being redirected..."==l||"Un instant..."==l||"Just a moment..."==l||"Redirecting..."==l))throw new Error("Captcha error, please open in webview (or the website has changed url)");return[2,c]}}))}))},l.prototype.parseNovels=function(e){var t=this;e=(0,s.load)(e).html();var r=[];return(e.match(/<article([^]*?)<\/article>/g)||[]).forEach((function(e){var s=e.match(/<a href="([^\"]*)".*? title="([^\"]*)"/)||[],i=s[1],a=s[2];if(a&&i){var n=e.match(/<img [^>]*?src="([^\"]*)"[^>]*?(?: data-src="([^\"]*)")?[^>]*>/)||[],c=void 0;if(i.includes(t.site))c=i.replace(t.site,"");else{var l=i.split("/");l.shift(),l.shift(),l.shift(),c=l.join("/")}r.push({name:a,cover:n[2]||n[1]||o.defaultCover,path:c})}})),r},l.prototype.popularNovels=function(s,r){return e(this,arguments,void 0,(function(e,s){var r,i,a,o,n,c,l,u,h,p=s.filters,v=s.showLatestNovels;return t(this,(function(t){switch(t.label){case 0:for(a in r=null!==(h=null===(u=this.options)||void 0===u?void 0:u.seriesPath)&&void 0!==h?h:"/series/",i=this.site+r+"?page="+e,p||(p=this.filters||{}),v&&(i+="&order=latest"),p)if("object"==typeof p[a].value)for(o=0,n=p[a].value;o<n.length;o++)c=n[o],i+="&".concat(a,"=").concat(c);else p[a].value&&(i+="&".concat(a,"=").concat(p[a].value));return[4,this.safeFetch(i,!1)];case 1:return l=t.sent(),[2,this.parseNovels(l)]}}))}))},l.prototype.parseNovel=function(s){return e(this,void 0,void 0,(function(){var e,i,l,u,h,p,v,d,f,m,g,b,w,y,k,N,S,C,x,L,j,q,_,E;return t(this,(function(t){switch(t.label){case 0:return e=this.site,[4,this.safeFetch(e+s,!1)];case 1:return i=t.sent(),l={path:s,name:"",genres:"",summary:"",author:"",artist:"",status:"",chapters:[]},u=!1,h=!1,p=0,v=!1,d=!1,f=!1,m=!1,g=!1,b=!1,w=!1,y=0,k=!1,N=!1,S=[],C={},x=!!(null!==(j=n.storage.get("hideLocked"))&&void 0!==j?j:null===(q=this.pluginSettings)||void 0===q?void 0:q.hideLocked.value),L=new r.Parser({onopentag:function(t,s){var r;!l.cover&&(null===(r=s.class)||void 0===r?void 0:r.includes("ts-post-image"))?(l.name=s.title,l.cover=s["data-src"]||s.src||o.defaultCover):"genxed"===s.class||"sertogenre"===s.class?u=!0:u&&"a"===t?h=!0:"div"!==t||"entry-content"!==s.class&&"description"!==s.itemprop?"spe"===s.class||"serl"===s.class?v=!0:v&&"span"===t?d=!0:"div"===t&&"sertostat"===s.class?(v=!0,d=!0,g=!0):s.class&&s.class.includes("eplister")?b=!0:b&&"li"===t?w=!0:w?"a"===t&&void 0===C.path?C.path=s.href.replace(e,"").trim():"epl-num"===s.class?y=1:"epl-title"===s.class?y=2:"epl-date"===s.class?y=3:"epl-price"===s.class&&(y=4):!p||"div"!==t&&"script"!==t||p++:p++},ontext:function(e){var t,s;if(u)h&&(l.genres+=e+", ");else if(1===p&&e.trim())l.summary+=e;else if(v){if(d){var r=e.toLowerCase().replace(":","").trim();if(f)l.author+=e||"Unknown";else if(m)l.artist+=e||"Unknown";else if(g)switch(r){case"مكتملة":case"completed":case"complété":case"completo":case"completado":case"tamamlandı":l.status=a.NovelStatus.Completed;break;case"مستمرة":case"ongoing":case"en cours":case"em andamento":case"en progreso":case"devam ediyor":l.status=a.NovelStatus.Ongoing;break;case"متوقفة":case"hiatus":case"en pause":case"hiato":case"pausa":case"pausado":case"duraklatıldı":l.status=a.NovelStatus.OnHiatus;break;default:l.status=a.NovelStatus.Unknown}switch(r){case"الكاتب":case"author":case"auteur":case"autor":case"yazar":f=!0;break;case"الحالة":case"status":case"statut":case"estado":case"durum":g=!0;break;case"الفنان":case"artist":case"artiste":case"artista":case"çizer":m=!0}}}else if(b&&w)if(1===y)e.includes("🔒")?(k=!0,N=!0):N&&(k=!1),c(e.replace("🔒","").trim(),C);else if(2===y)C.name=(null===(s=null===(t=e.match(RegExp("^".concat(l.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"\\s*(.+)"))))||void 0===t?void 0:t[1])||void 0===s?void 0:s.trim())||e.trim(),C.chapterNumber||c(e,C);else if(3===y)C.releaseTime=e;else if(4===y){switch(r=e.toLowerCase().trim()){case"free":case"gratuit":case"مجاني":case"livre":case"":k=!1;break;default:k=!0}}},onclosetag:function(e){var t,s,r;u?h?h=!1:(u=!1,l.genres=null===(t=l.genres)||void 0===t?void 0:t.slice(0,-2)):p?"p"===e?l.summary+="\n\n":"br"===e?l.summary+="\n":"div"!==e&&"script"!==e||p--:v?d?"span"===e&&(d=!1,f&&l.author?f=!1:m&&l.artist?m=!1:g&&""!==l.status&&(g=!1)):"div"===e&&(v=!1,l.author=null===(s=l.author)||void 0===s?void 0:s.trim(),l.artist=null===(r=l.artist)||void 0===r?void 0:r.trim()):b&&(w?1===y||2===y||3===y||4===y?y=0:"li"===e&&(w=!1,C.chapterNumber||(C.chapterNumber=0),k&&(C.name="🔒 "+C.name),x&&k||S.push(C),C={}):"ul"===e&&(b=!1))}}),L.write(i),L.end(),S.length&&((null===(_=this.options)||void 0===_?void 0:_.reverseChapters)&&S.reverse(),l.chapters=S),l.summary=null===(E=l.summary)||void 0===E?void 0:E.trim(),[2,l]}}))}))},l.prototype.parseChapter=function(r){return e(this,void 0,void 0,(function(){var e,i,a,o,n;return t(this,(function(t){switch(t.label){case 0:return[4,this.safeFetch(this.site+r,!1)];case 1:return e=t.sent(),i=(0,s.load)(e),null===(o=this.options)||void 0===o||o.customTransformJs,a=i("div.epcontent"),[2,null!==(n=a.html())&&void 0!==n?n:""]}}))}))},l.prototype.searchNovels=function(s,r){return e(this,void 0,void 0,(function(){var e,i;return t(this,(function(t){switch(t.label){case 0:return e=this.site+"page/"+r+"/?s="+encodeURIComponent(s),[4,this.safeFetch(e,!0)];case 1:return i=t.sent(),[2,this.parseNovels(i)]}}))}))},l}())({id:"betternovels",sourceSite:"https://betternovels.net/",sourceName:"Better Novels",options:{lang:"Portuguese"}});exports.default=l;